---
- name: Check if secrets source directory exists
  delegate_to: localhost
  run_once: true
  stat:
    path: "{{ kolla_secrets_src }}"
  register: _secrets_root

- name: Find group secret directories
  delegate_to: localhost
  run_once: true
  find:
    paths: "{{ kolla_secrets_src }}"
    file_type: directory
    depth: 1
  register: _secret_dirs
  when: _secrets_root.stat.exists

- name: Gather files for each secret directory
  delegate_to: localhost
  run_once: true
  when: _secret_dirs.files is defined
  loop: "{{ _secret_dirs.files }}"
  loop_control:
    loop_var: _dir
    label: "{{ _dir.path }}"
  find:
    paths: "{{ _dir.path }}"
    file_type: file
  register: _secret_files_results

- name: Build secret files mapping
  delegate_to: localhost
  run_once: true
  set_fact:
    kolla_secret_files: "{{ kolla_secret_files | default({}) | combine({ (_item.item.path | basename): _item.files }) }}"
  loop: "{{ _secret_files_results.results | default([]) }}"
  loop_control:
    loop_var: _item

- name: Debug empty secret directories
  delegate_to: localhost
  run_once: true
  debug:
    msg: "Secret directory {{ _item.item.path }} exists but contains no files"
  when:
    - _item.matched | default(0) | int == 0
  loop: "{{ _secret_files_results.results | default([]) }}"
  loop_control:
    loop_var: _item

- name: Share secret files mapping with all hosts
  set_fact:
    kolla_secret_files: "{{ hostvars['localhost'].kolla_secret_files | default({}) }}"

- name: Process secrets for host groups
  include_tasks: process_group.yml
  when:
    - kolla_secret_files.get(group) is defined
    - kolla_secret_files[group] | length > 0
  vars:
    my_groups: "{{ group_names }}"
  loop: "{{ my_groups }}"
  loop_control:
    loop_var: group
    label: "{{ group }}"

- name: Debug groups skipped
  debug:
    msg: "No secrets found for group {{ group }} - skipping"
  when: kolla_secret_files.get(group) is not defined or kolla_secret_files[group] | length == 0
  vars:
    my_groups: "{{ group_names }}"
  loop: "{{ my_groups }}"
  loop_control:
    loop_var: group
    label: "{{ group }}"
