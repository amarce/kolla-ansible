---
- name: Skip provider interface attachment for empty bridge name
  debug:
    msg: "Skipping provider interface mapping because the bridge name is empty"
    verbosity: 1
  when: provider_bridge | default('') | length == 0

- name: Manage provider interface {{ provider_port | default('') }} on bridge {{ provider_bridge }}
  when: provider_bridge | default('') | length > 0
  block:
    - name: Skip provider interface attachment when no interface is defined
      debug:
        msg: "No external interface defined for provider bridge {{ provider_bridge }}"
        verbosity: 1
      when: provider_port | default('') | length == 0

    - name: Guard against attaching provider bridge {{ provider_bridge }} to itself
      debug:
        msg: >-
          Skipping provider port attachment because the external interface "{{ provider_port }}" resolves to the bridge name "{{ provider_bridge }}"
        warn: true
      when:
        - provider_port | default('') | length > 0
        - provider_bridge == provider_port

    - name: Manage provider interface {{ provider_port }} attachment and options
      when:
        - provider_port | default('') | length > 0
        - provider_bridge != provider_port
      block:
        - name: Initialize provider interface state facts
          set_fact:
            provider_port_current_bridge: ''
            provider_port_state: "{{ provider_port_state_preloaded | default({}) }}"

        - name: Get current bridge for provider interface {{ provider_port }}
          become: true
          kolla_toolbox:
            container_engine: "{{ kolla_container_engine }}"
            user: root
            module_name: command
            # Older Open vSwitch releases (e.g. Mitaka era) do not support
            # "--if-exists" for the introspection command "port-to-br". Treat
            # a non-zero return code as "no bridge" instead of a fatal error.
            module_args: "ovs-vsctl --timeout=10 port-to-br {{ provider_port }}"
          register: ovs_provider_port_bridge
          changed_when: false
          failed_when: false

        - name: Record provider interface {{ provider_port }} bridge membership
          set_fact:
            provider_port_current_bridge: "{{ (ovs_provider_port_bridge.stdout | default('') | trim) if ovs_provider_port_bridge.rc == 0 else '' }}"

        - name: Fail when provider interface {{ provider_port }} is attached to another bridge
          fail:
            msg: >-
              Provider interface {{ provider_port }} is currently attached to bridge {{ provider_port_current_bridge }} and cannot be moved automatically to {{ provider_bridge }}.
          when:
            - provider_port_current_bridge | length > 0
            - provider_port_current_bridge != provider_bridge

        - name: Attach provider interface {{ provider_port }} to bridge {{ provider_bridge }}
          become: true
          kolla_toolbox:
            container_engine: "{{ kolla_container_engine }}"
            user: root
            module_name: command
            module_args: "ovs-vsctl --timeout=10 --may-exist add-port {{ provider_bridge }} {{ provider_port }}"
          register: ovs_provider_bridge_attach
          when: provider_port_current_bridge | length == 0
          changed_when: provider_port_current_bridge | length == 0

        - name: Log provider interface {{ provider_port }} attachment to bridge {{ provider_bridge }}
          debug:
            msg: "Attached provider interface {{ provider_port }} to {{ provider_bridge }}"
            verbosity: 1
          when:
            - ovs_provider_bridge_attach is defined
            - ovs_provider_bridge_attach is changed

        - name: Log provider interface {{ provider_port }} already attached to {{ provider_bridge }}
          debug:
            msg: "Provider interface {{ provider_port }} already attached to {{ provider_bridge }}"
            verbosity: 1
          when: provider_port_current_bridge == provider_bridge

        - name: Collect provider interface {{ provider_port }} state
          become: true
          kolla_toolbox:
            container_engine: "{{ kolla_container_engine }}"
            user: root
            module_name: command
            module_args: >-
              ovs-vsctl --timeout=10 --format=json
              --columns=name,tag,trunks,external_ids,other_config,type,options
              find Port "name=\"{{ provider_port }}\""
          register: ovs_provider_port_state
          changed_when: false
          failed_when: ovs_provider_port_state.rc not in [0]
          when:
            - provider_port_options | default({}) | length > 0
            - provider_port_state | default({}) | length == 0

        - name: Parse provider interface {{ provider_port }} state
          set_fact:
            provider_port_state: >-
              {{
                (
                  (
                    (ovs_provider_port_state.get('stdout', '') | trim | length > 0)
                    | ternary((ovs_provider_port_state.get('stdout', '') | trim | from_json | ovsdb_rows), [])
                  )
                  | first
                )
                | default({})
              }}
          when:
            - ovs_provider_port_state is defined
            - not (ovs_provider_port_state.skipped | default(false))

        - name: Define provider interface {{ provider_port }} option field descriptors
          set_fact:
            provider_port_option_fields:
              - field: tag
                default: []
              - field: trunks
                default: []
              - field: external_ids
                default: {}
              - field: other_config
                default: {}
              - field: type
                default: ''
              - field: options
                default: {}
          when: provider_port_options | default({}) | length > 0

        - name: Configure provider interface {{ provider_port }} option fields
          become: true
          kolla_toolbox:
            container_engine: "{{ kolla_container_engine }}"
            user: root
            module_name: command
            module_args: >-
              ovs-vsctl --timeout=10 set Port {{ provider_port }}
              "{{ provider_port_option.field }}={{ provider_port_options[provider_port_option.field] | default(provider_port_option.default, true) | to_ovsdb }}"
          when:
            - provider_port_options is mapping
            - provider_port_options | length > 0
            - "provider_port_option.field in provider_port_options"
            - (provider_port_state.get(provider_port_option.field) | default(provider_port_option.default) | ovsdb_canonical) != (provider_port_options[provider_port_option.field] | default(provider_port_option.default, true) | ovsdb_canonical)
          loop: "{{ provider_port_option_fields | default([]) }}"
          loop_control:
            loop_var: provider_port_option
            label: "{{ provider_port_option.field }}"
          register: ovs_provider_port_set_fields
          changed_when: true
