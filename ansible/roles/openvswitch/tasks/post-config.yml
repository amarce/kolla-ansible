---
# NOTE(mnasiadka): external_ids:system-id uniquely identifies a physical system, used by OVN and other controllers
- name: Initialise OVSDB reachability state
  set_fact:
    ovsdb_reachable: false
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool

- name: Wait for openvswitch_db container
  become: true
  kolla_container_facts:
    action: get_containers
    container_engine: "{{ kolla_container_engine }}"
    name:
      - openvswitch_db
  register: ovsdb_container
  changed_when: false
  failed_when: false
  retries: 10
  delay: 3
  until: ovsdb_container.containers.openvswitch_db is defined
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - openvswitch_manage_db_container | bool

- name: Wait for Open vSwitch database socket
  become: true
  command: "{{ kolla_container_engine }} exec openvswitch_db ovsdb-client list-dbs"
  register: ovsdb_wait
  retries: 10
  delay: 3
  changed_when: false
  until: ovsdb_wait.rc == 0
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - ovsdb_container.containers.openvswitch_db is defined
    - openvswitch_manage_db_container | bool

- name: Mark managed OVSDB as reachable
  set_fact:
    ovsdb_reachable: "{{ (ovsdb_wait | default({})).get('rc', 1) == 0 }}"
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - openvswitch_manage_db_container | bool
    - ovsdb_wait is defined

- name: Probe external Open vSwitch database reachability
  become: true
  command: >-
    {{ kolla_container_engine }} exec kolla_toolbox ovsdb-client list-dbs unix:{{ openvswitch_db_socket }}
  register: external_ovsdb_probe
  changed_when: false
  failed_when: false
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - not openvswitch_manage_db_container | bool

- name: Record external OVSDB reachability
  set_fact:
    ovsdb_reachable: "{{ external_ovsdb_probe.rc == 0 }}"
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - not openvswitch_manage_db_container | bool

- name: Log OVSDB reachability status
  debug:
    msg: "Skipping OVSDB changes because the database is not reachable or not managed by kolla-ansible"
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - not ovsdb_reachable | bool

- name: Set system-id, hostname and hw-offload
  become: true
  kolla_toolbox:
    container_engine: "{{ kolla_container_engine }}"
    user: root
    module_name: openvswitch_db
    module_args:
      table: Open_vSwitch
      record: .
      col: "{{ item.col }}"
      key: "{{ item.name }}"
      value: "{{ item.value }}"
      state: "{{ item.state | default('present') }}"
  loop:
    - { col: "external_ids", name: "system-id", value: "{{ openvswitch_system_id }}" }
    - { col: "external_ids", name: "hostname", value: "{{ openvswitch_hostname }}" }
    - { col: "other_config", name: "hw-offload", value: true, state: "{{ 'present' if openvswitch_hw_offload | bool else 'absent' }}" }
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - ovsdb_reachable | bool
  notify:
    - "Restart openvswitch-vswitchd container"

- name: Ensure provider bridges exist with desired fail_mode
  vars:
    provider_bridges: "{{ neutron_bridge_name.split(',') | map('trim') | reject('equalto', '') | list }}"
  include_tasks: provider_bridge.yml
  loop: "{{ provider_bridges }}"
  loop_control:
    loop_var: provider_bridge
    label: "{{ provider_bridge }}"
  when:
    - provider_bridges | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Initialize provider bridge interface mappings
  set_fact:
    openvswitch_provider_interface_mappings: []

- name: Build provider bridge interface mappings
  vars:
    provider_bridges: "{{ (neutron_bridge_name | default('')).split(',') | map('trim') | reject('equalto', '') | list }}"
    provider_interfaces: "{{ (neutron_external_interface | default('')).split(',') | map('trim') | list }}"
    provider_port_options_map: "{{ openvswitch_provider_port_options | default({}) }}"
  set_fact:
    openvswitch_provider_interface_mappings: "{{ openvswitch_provider_interface_mappings + [
      {
        'bridge': provider_bridges[provider_index] | default(''),
        'port': (provider_interfaces[provider_index] if provider_interfaces | length > provider_index else ''),
        'options': (
          provider_port_options_map.get(provider_interfaces[provider_index], {})
          if provider_interfaces | length > provider_index and provider_interfaces[provider_index] | length > 0
          else {}
        )
      }
    ] }}"
  loop: "{{ range(provider_bridges | length) | list }}"
  loop_control:
    loop_var: provider_index
  when:
    - provider_bridges | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Ensure provider bridge interfaces are attached
  include_tasks: provider_interface.yml
  loop: "{{ openvswitch_provider_interface_mappings | default([]) }}"
  loop_control:
    loop_var: provider_mapping
    label: >-
      {{ provider_mapping.bridge | default('') }} <- {{ provider_mapping.port | default('') }}
  vars:
    provider_bridge: "{{ provider_mapping.bridge | default('') }}"
    provider_port: "{{ provider_mapping.port | default('') }}"
    provider_port_options: "{{ provider_mapping.options | default({}) }}"
  when:
    - (openvswitch_provider_interface_mappings | default([])) | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Check if openvswitch_vswitchd container is running
  become: true
  command: >-
    {{ kolla_container_engine }} container inspect -f '{{ '{{.State.Running}}' }}' openvswitch_vswitchd
  register: openvswitch_vswitchd_running
  changed_when: false
  failed_when: false
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - openvswitch_services['openvswitch-vswitchd'].enabled | bool

- name: Ensure runtime marker directory exists
  become: true
  file:
    path: "{{ openvswitch_vswitchd_runtime_marker_path | dirname }}"
    state: directory
    mode: "0755"
  when:
    - openvswitch_vswitchd_running.rc == 0
    - (openvswitch_vswitchd_running.stdout | trim | lower) == 'true'

- name: Record successful openvswitch_vswitchd startup marker
  become: true
  file:
    path: "{{ openvswitch_vswitchd_runtime_marker_path }}"
    state: touch
    mode: "0644"
  when:
    - openvswitch_vswitchd_running.rc == 0
    - (openvswitch_vswitchd_running.stdout | trim | lower) == 'true'
