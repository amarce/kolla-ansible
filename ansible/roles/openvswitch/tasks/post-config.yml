---
# NOTE(mnasiadka): external_ids:system-id uniquely identifies a physical system, used by OVN and other controllers
- name: Initialise OVSDB reachability state
  set_fact:
    ovsdb_reachable: false
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool

- name: Wait for openvswitch_db container
  become: true
  kolla_container_facts:
    action: get_containers
    container_engine: "{{ kolla_container_engine }}"
    name:
      - openvswitch_db
  register: ovsdb_container
  changed_when: false
  failed_when: false
  retries: 10
  delay: 3
  until: ovsdb_container.containers.openvswitch_db is defined
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - openvswitch_manage_db_container | bool

- name: Wait for Open vSwitch database socket
  become: true
  command: "{{ kolla_container_engine }} exec openvswitch_db ovsdb-client list-dbs"
  register: ovsdb_wait
  retries: 10
  delay: 3
  changed_when: false
  until: ovsdb_wait.rc == 0
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - ovsdb_container.containers.openvswitch_db is defined
    - openvswitch_manage_db_container | bool

- name: Mark managed OVSDB as reachable
  set_fact:
    ovsdb_reachable: "{{ (ovsdb_wait | default({})).get('rc', 1) == 0 }}"
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - openvswitch_manage_db_container | bool
    - ovsdb_wait is defined

- name: Probe external Open vSwitch database reachability
  become: true
  command: >-
    {{ kolla_container_engine }} exec kolla_toolbox ovsdb-client list-dbs unix:{{ openvswitch_db_socket }}
  register: external_ovsdb_probe
  changed_when: false
  failed_when: false
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - not openvswitch_manage_db_container | bool

- name: Record external OVSDB reachability
  set_fact:
    ovsdb_reachable: "{{ external_ovsdb_probe.rc == 0 }}"
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - not openvswitch_manage_db_container | bool

- name: Log OVSDB reachability status
  debug:
    msg: "Skipping OVSDB changes because the database is not reachable or not managed by kolla-ansible"
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - not ovsdb_reachable | bool

- name: Set system-id, hostname and hw-offload
  become: true
  kolla_toolbox:
    container_engine: "{{ kolla_container_engine }}"
    user: root
    module_name: openvswitch_db
    module_args:
      table: Open_vSwitch
      record: .
      col: "{{ item.col }}"
      key: "{{ item.name }}"
      value: "{{ item.value }}"
      state: "{{ item.state | default('present') }}"
  loop:
    - { col: "external_ids", name: "system-id", value: "{{ openvswitch_system_id }}" }
    - { col: "external_ids", name: "hostname", value: "{{ openvswitch_hostname }}" }
    - { col: "other_config", name: "hw-offload", value: true, state: "{{ 'present' if openvswitch_hw_offload | bool else 'absent' }}" }
  when:
    - openvswitch_services['openvswitch-vswitchd'].host_in_groups | bool
    - ovsdb_reachable | bool
  notify:
    - "Restart openvswitch-vswitchd container"

- name: Ensure provider bridges exist with desired fail_mode
  vars:
    provider_bridges: "{{ neutron_bridge_name.split(',') | map('trim') | reject('equalto', '') | list }}"
    ovs_provider_fail_mode_effective: "{{ ovs_provider_fail_mode | default('') | trim | lower }}"
  block:
    - name: Log effective ovs_provider_fail_mode
      debug:
        msg: "Effective ovs_provider_fail_mode='{{ ovs_provider_fail_mode_effective }}'"
        verbosity: 1

    - name: Require explicit ovs_provider_fail_mode definition when enabled
      assert:
        that:
          - not openvswitch_require_explicit_provider_fail_mode | bool
            or 'ovs_provider_fail_mode' in hostvars[inventory_hostname]
        fail_msg: >-
          openvswitch_require_explicit_provider_fail_mode=true requires
          ovs_provider_fail_mode to be explicitly set in inventory variables
          (for example group_vars/network/openvswitch.yml,
          /etc/kolla/globals.yml, or host_vars).

    - name: Validate ovs_provider_fail_mode value
      assert:
        that:
          - ovs_provider_fail_mode_effective in ['secure', 'standalone']
        fail_msg: >-
          ovs_provider_fail_mode must be either 'secure' or 'standalone',
          got '{{ ovs_provider_fail_mode }}'.

    - name: Ensure provider bridges exist with desired fail_mode
      include_tasks: provider_bridge.yml
  when:
    - provider_bridges | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Initialize provider bridge interface mappings
  set_fact:
    openvswitch_provider_interface_mappings: []
    openvswitch_provider_interface_self_mappings: []
    openvswitch_provider_interface_attach_mappings: []

- name: Build provider bridge interface mappings
  vars:
    provider_bridges: "{{ (neutron_bridge_name | default('')).split(',') | map('trim') | reject('equalto', '') | list }}"
    provider_interfaces: "{{ (neutron_external_interface | default('')).split(',') | map('trim') | list }}"
    provider_port_options_map: "{{ openvswitch_provider_port_options | default({}) }}"
    provider_port: "{{ provider_interfaces[provider_index] if provider_interfaces | length > provider_index else None }}"
  set_fact:
    openvswitch_provider_interface_mappings: "{{ openvswitch_provider_interface_mappings + [
      {
        'bridge': provider_bridges[provider_index],
        'port': provider_port,
        'options': provider_port_options_map.get(provider_port, {})
      }
    ] }}"
  loop: "{{ range(provider_bridges | length) | list }}"
  loop_control:
    loop_var: provider_index
  when:
    - provider_bridges | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Filter invalid provider bridge interface mappings
  set_fact:
    openvswitch_provider_interface_mappings: >-
      {{
        openvswitch_provider_interface_mappings
        | rejectattr('bridge', 'none')
        | rejectattr('port', 'none')
        | rejectattr('bridge', 'equalto', '')
        | rejectattr('port', 'equalto', '')
        | list
      }}
  when:
    - (openvswitch_provider_interface_mappings | default([])) | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Split provider bridge interface mappings by attachment behavior
  set_fact:
    openvswitch_provider_interface_self_mappings: "{{ openvswitch_provider_interface_self_mappings + ([provider_mapping] if provider_mapping.bridge == provider_mapping.port else []) }}"
    openvswitch_provider_interface_attach_mappings: "{{ openvswitch_provider_interface_attach_mappings + ([provider_mapping] if provider_mapping.bridge != provider_mapping.port else []) }}"
  loop: "{{ openvswitch_provider_interface_mappings | default([]) }}"
  loop_control:
    loop_var: provider_mapping
  when:
    - (openvswitch_provider_interface_mappings | default([])) | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Log self-referencing provider bridge interface mappings
  debug:
    msg: >-
      Skipping provider port attachment because the external interface "{{ provider_mapping.port }}"
      resolves to the bridge name "{{ provider_mapping.bridge }}"
    warn: true
  loop: "{{ openvswitch_provider_interface_self_mappings | default([]) }}"
  loop_control:
    loop_var: provider_mapping
    label: >-
      {{ provider_mapping.bridge | default('') }} <- {{ provider_mapping.port | default('') }}
  when:
    - (openvswitch_provider_interface_self_mappings | default([])) | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Initialize provider port preloaded state map
  set_fact:
    openvswitch_provider_ports_unique: "{{ (openvswitch_provider_interface_attach_mappings | default([]) | map(attribute='port') | reject('equalto', '') | unique | list) }}"
    openvswitch_provider_port_state_map: {}
    openvswitch_provider_port_bridge_map: {}
  when:
    - (openvswitch_provider_interface_attach_mappings | default([])) | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Bulk query provider port state from OVSDB
  become: true
  kolla_toolbox:
    container_engine: "{{ kolla_container_engine }}"
    user: root
    module_name: command
    module_args: >-
      ovs-vsctl --timeout=10 --format=json
      --columns=name,tag,trunks,external_ids,other_config,type,options
      list Port
  register: ovs_provider_ports_bulk_state
  changed_when: false
  failed_when: false
  when:
    - (openvswitch_provider_ports_unique | default([])) | length > 0
    - ovsdb_reachable | bool
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Bulk query OVSDB Port UUID to name linkage
  become: true
  kolla_toolbox:
    container_engine: "{{ kolla_container_engine }}"
    user: root
    module_name: command
    module_args: >-
      ovs-vsctl --timeout=10 --format=json
      --columns=_uuid,name
      list Port
  register: ovs_provider_ports_bulk_linkage
  changed_when: false
  failed_when: false
  when:
    - (openvswitch_provider_ports_unique | default([])) | length > 0
    - ovsdb_reachable | bool
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Bulk query OVSDB Bridge to Port UUID linkage
  become: true
  kolla_toolbox:
    container_engine: "{{ kolla_container_engine }}"
    user: root
    module_name: command
    module_args: >-
      ovs-vsctl --timeout=10 --format=json
      --columns=name,ports
      list Bridge
  register: ovs_provider_bridges_bulk_linkage
  changed_when: false
  failed_when: false
  when:
    - (openvswitch_provider_ports_unique | default([])) | length > 0
    - ovsdb_reachable | bool
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Build provider port preloaded state map from bulk query
  set_fact:
    openvswitch_provider_port_state_map: >-
      {{
        dict(
          (
            (ovs_provider_ports_bulk_state.stdout | from_json | ovsdb_rows)
            | selectattr('name', 'in', openvswitch_provider_ports_unique | default([]))
            | map(attribute='name')
            | zip(
                (ovs_provider_ports_bulk_state.stdout | from_json | ovsdb_rows)
                | selectattr('name', 'in', openvswitch_provider_ports_unique | default([]))
              )
          )
        )
      }}
  when:
    - ovs_provider_ports_bulk_state is defined
    - ovs_provider_ports_bulk_state.rc == 0
    - ovs_provider_ports_bulk_state.stdout | default('') | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Build provider port preloaded bridge map from bulk query
  vars:
    openvswitch_bulk_port_rows: "{{ ovs_provider_ports_bulk_linkage.stdout | from_json | ovsdb_rows }}"
    openvswitch_bulk_bridge_rows: "{{ ovs_provider_bridges_bulk_linkage.stdout | from_json | ovsdb_rows }}"
    openvswitch_bulk_port_uuid_name_map: "{{ dict(openvswitch_bulk_port_rows | map(attribute='_uuid') | zip(openvswitch_bulk_port_rows | map(attribute='name'))) }}"
    openvswitch_bulk_bridge_port_links: >-
      {%- set ns = namespace(links=[]) -%}
      {%- for bridge in openvswitch_bulk_bridge_rows -%}
      {%- set bridge_ports = bridge.ports if (bridge.ports is sequence and bridge.ports is not string) else ([bridge.ports] if (bridge.ports is defined and bridge.ports is not none and (bridge.ports | string | length > 0)) else []) -%}
      {%- for port_uuid in bridge_ports -%}
      {%- set _ = ns.links.append({'bridge': bridge.name, 'port_uuid': port_uuid}) -%}
      {%- endfor -%}
      {%- endfor -%}
      {{ ns.links }}
  set_fact:
    openvswitch_provider_port_bridge_map: >-
      {{
        openvswitch_provider_port_bridge_map
        | combine(
            {
              (openvswitch_bulk_port_uuid_name_map[provider_bridge_port_link.port_uuid]): provider_bridge_port_link.bridge
            },
            recursive=True
          )
      }}
  loop: "{{ openvswitch_bulk_bridge_port_links }}"
  loop_control:
    loop_var: provider_bridge_port_link
  when:
    - ovs_provider_ports_bulk_linkage is defined
    - ovs_provider_ports_bulk_linkage.rc == 0
    - ovs_provider_ports_bulk_linkage.stdout | default('') | length > 0
    - ovs_provider_bridges_bulk_linkage is defined
    - ovs_provider_bridges_bulk_linkage.rc == 0
    - ovs_provider_bridges_bulk_linkage.stdout | default('') | length > 0
    - provider_bridge_port_link.port_uuid in openvswitch_bulk_port_uuid_name_map
    - openvswitch_bulk_port_uuid_name_map[provider_bridge_port_link.port_uuid] in openvswitch_provider_ports_unique | default([])
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)

- name: Ensure provider bridge interfaces are attached
  include_tasks: provider_interface.yml
  loop: "{{ openvswitch_provider_interface_attach_mappings | default([]) }}"
  loop_control:
    loop_var: provider_mapping
    label: >-
      {{ provider_mapping.bridge | default('') }} <- {{ provider_mapping.port | default('') }}
  vars:
    provider_bridge: "{{ provider_mapping.bridge | default('') }}"
    provider_port: "{{ provider_mapping.port | default('') }}"
    provider_port_options: "{{ provider_mapping.options | default({}) }}"
    provider_port_state_preloaded: "{{ openvswitch_provider_port_state_map.get(provider_mapping.port | default(''), {}) if openvswitch_provider_port_state_map is mapping else {} }}"
    provider_port_current_bridge_preloaded: "{{ openvswitch_provider_port_bridge_map.get(provider_mapping.port | default(''), '') if openvswitch_provider_port_bridge_map is mapping else '' }}"
  when:
    - (openvswitch_provider_interface_attach_mappings | default([])) | length > 0
    - inventory_hostname in groups["network"]
      or (inventory_hostname in groups["compute"] and computes_need_external_bridge | bool )
    - not (kolla_action == 'reconfigure' and not openvswitch_manage_provider_bridges_on_reconfigure | bool)
