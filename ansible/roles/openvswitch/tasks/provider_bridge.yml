---
- name: Skip provider bridge {{ provider_bridge }} operations for empty name
  debug:
    msg: "Skipping provider bridge management because the name is empty"
    verbosity: 1
  when: provider_bridge | default('') | length == 0

- name: Manage provider bridge {{ provider_bridge }}
  become: true
  when: provider_bridge | default('') | length > 0
  block:
    - name: Check provider bridge {{ provider_bridge }} existence
      kolla_toolbox:
        container_engine: "{{ kolla_container_engine }}"
        user: root
        module_name: command
        module_args: "ovs-vsctl br-exists {{ provider_bridge }}"
      register: ovs_provider_bridge_check
      changed_when: false
      failed_when: ovs_provider_bridge_check.rc not in [0, 2]

    - name: Create provider bridge {{ provider_bridge }} when missing
      kolla_toolbox:
        container_engine: "{{ kolla_container_engine }}"
        user: root
        module_name: command
        module_args: "ovs-vsctl --may-exist add-br {{ provider_bridge }}"
      register: ovs_provider_bridge_create
      changed_when: ovs_provider_bridge_create.rc == 0
      when: ovs_provider_bridge_check.rc != 0

    - name: Log provider bridge {{ provider_bridge }} creation
      debug:
        msg: "Created provider bridge {{ provider_bridge }}"
        verbosity: 1
      when:
        - ovs_provider_bridge_create is defined
        - ovs_provider_bridge_create is changed

    - name: Log provider bridge {{ provider_bridge }} already present
      debug:
        msg: "Provider bridge {{ provider_bridge }} already exists"
        verbosity: 1
      when: ovs_provider_bridge_check.rc == 0

    - name: Reset provider bridge {{ provider_bridge }} fail_mode fact
      set_fact:
        provider_bridge_current_fail_mode: ''
      changed_when: false

    - name: Get provider bridge {{ provider_bridge }} fail_mode
      kolla_toolbox:
        container_engine: "{{ kolla_container_engine }}"
        user: root
        module_name: command
        module_args: "ovs-vsctl get-fail-mode {{ provider_bridge }}"
      register: ovs_provider_bridge_fail_mode
      changed_when: false
      failed_when: ovs_provider_bridge_fail_mode.rc not in [0, 2]
      when: ovs_provider_bridge_check.rc == 0

    - name: Store provider bridge {{ provider_bridge }} fail_mode value
      set_fact:
        provider_bridge_current_fail_mode: >-
          {{ (ovs_provider_bridge_fail_mode.stdout | default('') | trim
              | regex_replace('^"(.*)"$', '\\1')
              | regex_replace('^\\[\\]$', '')) }}
      changed_when: false
      when: ovs_provider_bridge_fail_mode is defined

    - name: Set provider bridge {{ provider_bridge }} fail_mode when required
      kolla_toolbox:
        container_engine: "{{ kolla_container_engine }}"
        user: root
        module_name: command
        module_args: "ovs-vsctl set-fail-mode {{ provider_bridge }} {{ ovs_provider_fail_mode }}"
      register: ovs_provider_bridge_set_fail_mode
      changed_when: ovs_provider_bridge_set_fail_mode.rc == 0
      failed_when: ovs_provider_bridge_set_fail_mode.rc != 0
      when:
        - ovs_provider_fail_mode | length > 0
        - ovs_provider_bridge_check.rc != 0 or provider_bridge_current_fail_mode != ovs_provider_fail_mode

    - name: Log provider bridge {{ provider_bridge }} fail_mode update
      debug:
        msg: "Updated provider bridge {{ provider_bridge }} fail_mode to {{ ovs_provider_fail_mode }}"
        verbosity: 1
      when:
        - ovs_provider_bridge_set_fail_mode is defined
        - ovs_provider_bridge_set_fail_mode is changed

    - name: Log provider bridge {{ provider_bridge }} fail_mode already set
      debug:
        msg: "Provider bridge {{ provider_bridge }} fail_mode already {{ ovs_provider_fail_mode }}"
        verbosity: 1
      when:
        - ovs_provider_bridge_check.rc == 0
        - ovs_provider_fail_mode | length > 0
        - provider_bridge_current_fail_mode == ovs_provider_fail_mode
