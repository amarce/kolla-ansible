---
- name: Ensure neutron-ovs-cleanup marker directory exists
  become: true
  file:
    path: "{{ neutron_ovs_cleanup_marker_file | dirname }}"
    state: directory
    mode: "0755"

- name: Check if neutron-ovs-cleanup has run
  become: true
  stat:
    path: "{{ neutron_ovs_cleanup_marker_file }}"
  register: ovs_cleanup_marker

- name: Running neutron-ovs-cleanup container
  vars:
    service_name: "neutron-openvswitch-agent"
    service: "{{ neutron_services[service_name] }}"
  become: true
  kolla_container:
    action: "start_container"
    common_options: "{{ docker_common_options }}"
    detach: False
    command: >-
      bash -c 'sudo -E kolla_set_configs && neutron-ovs-cleanup --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/openvswitch_agent.ini && touch {{ neutron_ovs_cleanup_marker_file }}'
    image: "{{ service.image }}"
    labels:
      OVSCLEANUP:
    name: "neutron_ovs_cleanup"
    restart_policy: no
    remove_on_exit: false
    volumes: "{{ [ node_config_directory ~ '/neutron-ovs-cleanup/:' ~ container_config_directory ~ '/:ro' ] + (service.volumes[1:] | list) }}"
  when:
    - service | service_enabled_and_mapped_to_host
    - not ovs_cleanup_marker.stat.exists

- name: Mark neutron-ovs-cleanup complete
  vars:
    service_name: "neutron-openvswitch-agent"
    service: "{{ neutron_services[service_name] }}"
  become: true
  file:
    path: "{{ neutron_ovs_cleanup_marker_file }}"
    state: touch
  when:
    - service | service_enabled_and_mapped_to_host
    - not ovs_cleanup_marker.stat.exists
