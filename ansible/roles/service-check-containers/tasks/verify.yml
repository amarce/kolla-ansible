---
# Verify that container and systemd unit exist and are active
- name: Reset verification facts
  set_fact:
    container_missing: false
    unit_missing_or_disabled: false
    container_needs_recreate: false
- name: Set container and unit names
  set_fact:
    container_name: "{{ item.value.container_name | default(item.key) }}"
    unit_name: >-
      {{ 'container-' if kolla_container_engine == 'podman' else 'kolla-' }}{{ item.value.container_name | default(item.key) }}{{ '' if kolla_container_engine == 'podman' else '-container' }}.service
    container_spec: "{{ item.value }}"

- name: Set desired healthcheck test
  set_fact:
    desired_healthcheck_test: "{{ container_spec.healthcheck.test | default([]) }}"

- name: Set service enabled fact
  set_fact:
    service_enabled: "{{ container_spec.enabled | default(True) | bool }}"

- name: Check container presence
  become: true
  command: >-
    {{ kolla_container_engine }}
    {{ 'container exists ' + container_name if kolla_container_engine == 'podman'
       else 'container inspect ' + container_name }}
  register: container_probe_initial
  changed_when: false
  failed_when: false

- block:
    - name: Ensure {{ container_name }} container exists before validation
      vars:
        service_name: "{{ item.key }}"
        service: "{{ container_spec }}"
        ensure_container_common_options: "{{ _service_check_common_options }}"
      import_tasks: roles/common/tasks/_ensure_service_container.yml

    - name: Re-check container presence after ensure
      become: true
      command: >-
        {{ kolla_container_engine }}
        {{ 'container exists ' + container_name if kolla_container_engine == 'podman'
           else 'container inspect ' + container_name }}
      register: container_probe_after_ensure
      changed_when: false
      failed_when: false
  when:
    - service_enabled | bool
    - (container_probe_initial.rc | default(1)) != 0
  vars:
    _service_check_common_options: >-
      {{ docker_common_options if kolla_container_engine != 'podman'
         else (docker_common_options | dict2items
               | rejectattr('key', 'in', ['restart_policy', 'restart_retries'])
                | list | items2dict) }}

- name: Refresh container presence after ensure
  become: true
  command: >-
    {{ kolla_container_engine }}
    {{ 'container exists ' + container_name if kolla_container_engine == 'podman'
       else 'container inspect ' + container_name }}
  register: container_probe
  changed_when: false
  failed_when: false

- name: Inspect container
  become: true
  kolla_container_facts:
    action: get_containers
    container_engine: "{{ kolla_container_engine }}"
    name:
      - "{{ container_name }}"
  register: inspect_result
  when:
    - container_probe is defined
    - container_probe.rc | default(1) == 0

- name: Set container_inspect fact
  set_fact:
    container_inspect: >-
      {{ (inspect_result.containers | default({})).get(container_name, {}) }}

- name: Check unit file exists
  become: true
  stat:
    path: "/etc/systemd/system/{{ unit_name }}"
  register: unit_file
  changed_when: false
  failed_when: false

- name: Check unit enabled
  become: true
  command: systemctl is-enabled --quiet {{ unit_name }}
  register: unit_enabled_res
  changed_when: false
  failed_when: false
  when: unit_file.stat.exists

- name: Set unit enabled fact
  set_fact:
    unit_enabled: "{{ unit_file.stat.exists and (unit_enabled_res.rc | default(1)) == 0 }}"

- name: Check unit active
  become: true
  command: systemctl is-active --quiet {{ unit_name }}
  register: unit_active
  changed_when: false
  failed_when: false
  when: unit_file.stat.exists

- name: Record container and unit status
  set_fact:
    container_missing: "{{ (container_probe.rc | default(1)) != 0 }}"
    unit_missing_or_disabled: "{{ not unit_enabled }}"
    needs_start: >-
      {{ (container_probe.rc | default(1)) != 0 or (unit_file.stat.exists and (not unit_enabled or unit_active.rc | default(3) != 0)) }}

- block:
    - name: Detect health-check drift
      set_fact:
        container_needs_recreate: true
      when:
        - not container_missing
        - (container_inspect.Config.Healthcheck.Test | default([]) | to_json)
          != (desired_healthcheck_test | to_json)

    - name: Detect configuration drift from compare_container
      set_fact:
        container_needs_recreate: true
      when: service_check_compare_results[item.key] | default(false)

    - name: Init service fact for handlers
      set_fact:
        service: "{{ container_spec | combine({'unit_file_exists': unit_file.stat.exists}) }}"

    - name: Clear host error state
      meta: clear_host_errors

    - name: Ensure missing containers trigger recreation
      set_fact:
        container_needs_recreate: true
      when: container_missing | bool

    - name: Queue service-check action when needed
      set_fact:
        service_check_pending_actions: "{{ (
            service_check_pending_actions | default([])
          )
          | rejectattr('container_name', 'equalto', container_name)
          | list
          + [
              {
                'container_name': container_name,
                'unit_name': unit_name,
                'service': service,
                'container_inspect': container_inspect,
                'container_missing': container_missing | bool,
                'container_needs_recreate': container_needs_recreate | bool,
                'unit_enabled': unit_enabled | bool,
                'needs_start': needs_start | bool
              }
            ] }}"
      when:
        - service.enabled | default(True) | bool
        - container_missing | bool or container_needs_recreate | bool or needs_start | bool
    - name: Record queued service-check summary
      set_fact:
        service_check_pending_summary: "{{ (
            service_check_pending_summary | default([])
          )
          | rejectattr('container_name', 'equalto', container_name)
          | list
          + [
              {
                'service_name': item.key,
                'container_name': container_name,
                'unit_name': unit_name,
                'container_missing': container_missing | bool,
                'container_needs_recreate': container_needs_recreate | bool,
                'needs_start': needs_start | bool,
              }
            ] }}"
      when:
        - service.enabled | default(True) | bool
        - container_missing | bool or container_needs_recreate | bool or needs_start | bool
      notify: Process service-check actions

    - name: Flush queued service-check actions
      meta: flush_handlers

    - name: Ensure unit running when container exists
      become: true
      systemd:
        name: "{{ unit_name }}"
        state: restarted
        enabled: true
      when:
        - not container_missing
        - unit_file.stat.exists
        - kolla_container_engine == 'docker'
        - (unit_active.rc | default(0)) != 0
  when:
    - service_enabled | bool
      or unit_file.stat.exists
      or not container_missing | bool
    - container_name not in service_check_exclude_services
