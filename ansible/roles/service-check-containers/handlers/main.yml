- name: Refresh handler unit file state
  become: true
  stat:
    path: "/etc/systemd/system/{{ unit_name }}"
  register: handler_unit_file
  changed_when: false
  failed_when: false
  when: unit_name is defined

- name: Propagate handler unit file state
  set_fact:
    service: "{{ (service | default({})) | combine({'unit_file_exists': handler_unit_file.stat.exists | default(service.unit_file_exists | default(false))}, recursive=True) }}"
  when: unit_name is defined

- name: Recreate container
  import_tasks: recreate.yml

- name: Start container immediately after (re)create
  become: true
  vars:
    _service_check_common_options: >-
      {{ docker_common_options if kolla_container_engine != 'podman'
         else (docker_common_options | dict2items
               | rejectattr('key', 'in', ['restart_policy', 'restart_retries'])
               | list | items2dict) }}
  kolla_container:
    action: start_container
    common_options: "{{ _service_check_common_options }}"
    name: "{{ container_name }}"

- name: Ensure unit reflects new state
  become: true
  systemd:
    name: "{{ unit_name }}"
    state: restarted
  when:
    - unit_enabled
    - service.unit_file_exists | default(false) | bool
    - kolla_container_engine == 'docker' or kolla_podman_use_systemd | bool

- name: Recreate container when missing or drifted
  listen: Restart container
  when:
    - container_missing | bool or container_needs_recreate | bool
  import_tasks: recreate.yml
  notify: Restart unit as fallback

- name: Attempt runtime restart first
  listen: Restart container
  become: true
  vars:
    _service_check_common_options: >-
      {{ docker_common_options if kolla_container_engine != 'podman'
         else (docker_common_options | dict2items
               | rejectattr('key', 'in', ['restart_policy', 'restart_retries'])
               | list | items2dict) }}
  kolla_container:
    action: restart_container
    common_options: "{{ _service_check_common_options }}"
    name: "{{ container_name }}"
  register: runtime_restart
  ignore_errors: true
  when:
    - not container_needs_recreate | bool
    - not (
        kolla_container_engine == 'podman' and
        kolla_podman_use_systemd | bool and
        service.unit_file_exists | default(false)
      )

- name: Restart unit via systemd when available
  listen: Restart container
  become: true
  systemd:
    name: "{{ unit_name }}"
    state: restarted
  when:
    - not container_needs_recreate | bool
    - kolla_container_engine == 'podman'
    - kolla_podman_use_systemd | bool
    - service.unit_file_exists | default(false) | bool

- name: Ensure unit enabled
  listen: Restart container
  become: true
  systemd:
    name: "{{ unit_name }}"
    enabled: true
  when:
    - not container_needs_recreate | bool
    - runtime_restart is failed
    - service.unit_file_exists | default(false) | bool
    - kolla_container_engine == 'docker' or kolla_podman_use_systemd | bool
    - not (kolla_container_engine == 'podman' and kolla_podman_use_systemd | bool)

- name: Restart unit as fallback
  listen: Restart container
  become: true
  systemd:
    name: "{{ unit_name }}"
    state: restarted
  when:
    - not container_needs_recreate | bool
    - runtime_restart is failed
    - service.unit_file_exists | default(false) | bool
    - kolla_container_engine == 'docker' or kolla_podman_use_systemd | bool
    - not (kolla_container_engine == 'podman' and kolla_podman_use_systemd | bool)

