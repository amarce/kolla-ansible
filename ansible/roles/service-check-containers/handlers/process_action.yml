---
- name: Prepare handler context for {{ handler_context.container_name }}
  set_fact:
    container_name: "{{ handler_context.container_name }}"
    unit_name: "{{ handler_context.unit_name }}"
    service: "{{ handler_context.service }}"
    container_inspect: "{{ handler_context.container_inspect | default({}) }}"
    container_missing: "{{ handler_context.container_missing | bool }}"
    container_needs_recreate: "{{ handler_context.container_needs_recreate | bool }}"
    unit_enabled: "{{ handler_context.unit_enabled | bool }}"
    needs_start: "{{ handler_context.needs_start | bool }}"
    service_use_systemd: "{{ handler_context.service_use_systemd | default(kolla_container_engine == 'docker') | bool }}"
    openvswitch_vswitchd_runtime_protection_active: "{{ handler_context.openvswitch_vswitchd_runtime_protection_active | default(false) | bool }}"

- name: Refresh handler unit file state
  become: true
  stat:
    path: "/etc/systemd/system/{{ unit_name }}"
  register: handler_unit_file
  changed_when: false
  failed_when: false
  when: unit_name is defined

- name: Propagate handler unit file state
  set_fact:
    service: "{{ (service | default({})) | combine({'unit_file_exists': handler_unit_file.stat.exists | default(service.unit_file_exists | default(false))}, recursive=True) }}"
  when: unit_name is defined

- block:
    - name: Ensure {{ container_name }} container exists when missing
      vars:
        service_spec: "{{ service }}"
      import_tasks: roles/common/tasks/_ensure_service_container.yml
      vars:
        service_name: "{{ handler_context.service_name | default(container_name) }}"
        service: "{{ service_spec }}"
        ensure_container_common_options: "{{ _service_check_common_options }}"
    - name: Refresh handler container facts
      become: true
      kolla_container_facts:
        action: get_containers
        container_engine: "{{ kolla_container_engine }}"
        name:
          - "{{ container_name }}"
      register: handler_container_refresh
      changed_when: false
      failed_when: false
    - name: Update handler container inspect data
      set_fact:
        container_inspect: "{{ (handler_container_refresh.containers | default({})).get(container_name, {}) }}"
  when: container_missing | bool
  vars:
    _service_check_common_options: >-
      {{ docker_common_options if kolla_container_engine != 'podman'
         else (docker_common_options | dict2items
               | rejectattr('key', 'in', ['restart_policy', 'restart_retries'])
               | list | items2dict) }}

- block:
    - name: Recreate container when drifted
      include_tasks: "{{ role_path }}/tasks/recreate.yml"
  when:
    - container_needs_recreate | bool
    - not container_missing | bool
    - not openvswitch_vswitchd_runtime_protection_active | bool

- block:
    - name: Start container immediately after ensure or recreate
      become: true
      vars:
        _service_check_common_options: >-
          {{ docker_common_options if kolla_container_engine != 'podman'
             else (docker_common_options | dict2items
                   | rejectattr('key', 'in', ['restart_policy', 'restart_retries'])
                   | list | items2dict) }}
      kolla_container:
        action: start_container
        common_options: "{{ _service_check_common_options }}"
        name: "{{ container_name }}"

    - name: Ensure unit reflects new state
      become: true
      systemd:
        name: "{{ unit_name }}"
        state: "{{ 'started' if openvswitch_vswitchd_runtime_protection_active | bool else 'restarted' }}"
      when:
        - unit_name is defined
        - unit_enabled | bool
        - service.unit_file_exists | default(false) | bool
        - service_use_systemd | bool
  when:
    - container_missing | bool or container_needs_recreate | bool

- block:
    - name: Restore runtime state
      become: true
      vars:
        _service_check_common_options: >-
          {{ docker_common_options if kolla_container_engine != 'podman'
             else (docker_common_options | dict2items
                   | rejectattr('key', 'in', ['restart_policy', 'restart_retries'])
                   | list | items2dict) }}
      kolla_container:
        action: "{{ 'start_container' if openvswitch_vswitchd_runtime_protection_active | bool else 'restart_container' }}"
        common_options: "{{ _service_check_common_options }}"
        name: "{{ container_name }}"
      register: runtime_restart
      ignore_errors: true

    - name: Ensure unit enabled
      become: true
      systemd:
        name: "{{ unit_name }}"
        enabled: true
      when:
        - unit_name is defined
        - service.unit_file_exists | default(false) | bool
        - runtime_restart is failed
        - service_use_systemd | bool

    - name: Restart unit as fallback
      become: true
      systemd:
        name: "{{ unit_name }}"
        state: "{{ 'started' if openvswitch_vswitchd_runtime_protection_active | bool else 'restarted' }}"
      when:
        - unit_name is defined
        - service.unit_file_exists | default(false) | bool
        - runtime_restart is failed
        - service_use_systemd | bool

  when:
    - not (container_missing | bool or container_needs_recreate | bool)
    - needs_start | bool

- name: Warn when runtime protection enforces start-only recovery
  debug:
    msg: >-
      Runtime protection marker {{ openvswitch_vswitchd_runtime_marker_file }} is present but
      openvswitch_vswitchd is not running. Performing start-only recovery and skipping restart
      actions. Set openvswitch_vswitchd_break_glass=true to override this protection.
  when:
    - container_name == 'openvswitch_vswitchd'
    - openvswitch_vswitchd_runtime_protection_active | bool
    - needs_start | bool

- name: Verify openvswitch_vswitchd healthy before recording runtime marker
  become: true
  kolla_container_facts:
    action: get_containers
    container_engine: "{{ kolla_container_engine }}"
    name: "{{ container_name }}"
  register: openvswitch_vswitchd_health
  retries: "{{ kolla_service_healthcheck_retries | default(60) }}"
  delay: "{{ kolla_service_healthcheck_delay | default(2) }}"
  until:
    - openvswitch_vswitchd_health.containers.get(container_name, {}).get('State', {}).get('Status') == 'running'
    - (openvswitch_vswitchd_health.containers.get(container_name, {}).get('State', {}).get('Health', {}).get('Status', 'healthy')) == 'healthy'
  when:
    - container_name == 'openvswitch_vswitchd'
    - openvswitch_vswitchd_protect_runtime | default(true) | bool

- name: Ensure openvswitch runtime marker directory exists
  become: true
  file:
    path: "{{ openvswitch_vswitchd_runtime_marker_file | dirname }}"
    state: directory
    mode: "0755"
  when:
    - container_name == 'openvswitch_vswitchd'
    - openvswitch_vswitchd_protect_runtime | default(true) | bool

- name: Record openvswitch_vswitchd runtime marker
  become: true
  file:
    path: "{{ openvswitch_vswitchd_runtime_marker_file }}"
    state: touch
    mode: "0644"
  when:
    - container_name == 'openvswitch_vswitchd'
    - openvswitch_vswitchd_protect_runtime | default(true) | bool
