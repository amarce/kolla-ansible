- name: Check neutron_ovs_cleanup marker
  become: true
  stat:
    path: "{{ neutron_ovs_cleanup_marker_file }}"
  register: ovs_cleanup_marker
  when: item == 'neutron_ovs_cleanup'

- name: Start {{ item }} service
  become: true
  systemd:
    name: "kolla-{{ item }}-container.service"
    state: started
    enabled: true
  when:
    - item != 'neutron_ovs_cleanup' or not ovs_cleanup_marker.stat.exists | default(false)

- name: Wait for neutron_ovs_cleanup to finish
  become: true
  kolla_container_facts:
    action: get_containers_state
    container_engine: "{{ kolla_container_engine }}"
    name: neutron_ovs_cleanup
  register: cleanup_state
  retries: 12
  delay: 5
  until: cleanup_state.states.neutron_ovs_cleanup != 'running'
  when:
    - item == 'neutron_ovs_cleanup'
    - not ovs_cleanup_marker.stat.exists | default(false)
