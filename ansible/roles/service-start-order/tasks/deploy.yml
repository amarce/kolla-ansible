---
- name: Detect services with systemd units
  become: true
  stat:
    path: "/etc/systemd/system/{{ kolla_service_unit_prefix }}{{ item }}{{ kolla_service_unit_suffix }}.service"
  loop: "{{ kolla_service_start_priority }}"
  register: service_units

# Alias units (kolla-<name>-container.service) may be enabled instead of the
# container-<name>.service units. Detect these so that start-order pairs are
# built even when only alias units exist.
- name: Detect services with alias systemd units
  become: true
  stat:
    path: "/etc/systemd/system/kolla-{{ item }}-container.service"
  loop: "{{ kolla_service_start_priority }}"
  when: kolla_container_engine == 'podman'
  register: alias_service_units

- name: Build list of services with systemd units
  vars:
    existing_units: "{{ (service_units.results + (alias_service_units.results | default([]))) | selectattr('stat.exists') | map(attribute='item') | list }}"
  set_fact:
    start_order_services: "{{ kolla_service_start_priority | select('in', existing_units) | list }}"

- name: Detect enabled service units
  become: true
  command: "systemctl is-enabled {{ kolla_service_unit_prefix }}{{ item }}{{ kolla_service_unit_suffix }}.service"
  loop: "{{ start_order_services }}"
  register: service_enabled
  changed_when: false
  failed_when: false
  when: (start_order_services | length) > 0

- name: Detect enabled alias service units
  become: true
  command: "systemctl is-enabled kolla-{{ item }}-container.service"
  loop: "{{ start_order_services | select('in', alias_service_units.results | default([]) | selectattr('stat.exists') | map(attribute='item') | list) | list }}"
  register: alias_service_enabled
  changed_when: false
  failed_when: false
  when:
    - kolla_container_engine == 'podman'
    - (start_order_services | length) > 0

- name: Build list of enabled services
  set_fact:
    enabled_services: "{{ (
      ((service_enabled.results if service_enabled is defined else []) | selectattr('rc', 'equalto', 0) | map(attribute='item') | list)
      + ((alias_service_enabled.results if alias_service_enabled is defined else []) | selectattr('rc', 'equalto', 0) | map(attribute='item') | list)
    ) | unique }}"

- name: Build start order pairs
  set_fact:
    start_order_pairs: "{{ lookup('template', 'start-order-pairs.json.j2') | from_json }}"

- name: Ensure override directories exist
  become: true
  file:
    path: "/etc/systemd/system/{{ kolla_service_unit_prefix }}{{ item.1 }}{{ kolla_service_unit_suffix }}.service.d"
    state: directory
  loop: "{{ start_order_pairs }}"
  notify: Reload systemd

- name: Ensure alias override directories exist
  become: true
  file:
    path: "/etc/systemd/system/kolla-{{ item.1 }}-container.service.d"
    state: directory
  loop: "{{ start_order_pairs }}"
  when: kolla_container_engine == 'podman'
  notify: Reload systemd

- name: Configure start order overrides
  become: true
  template:
    src: start-order.conf.j2
    dest: "/etc/systemd/system/{{ kolla_service_unit_prefix }}{{ item.1 }}{{ kolla_service_unit_suffix }}.service.d/start-order.conf"
    mode: "0644"
  loop: "{{ start_order_pairs }}"
  register: start_order_override_result
  notify: Reload systemd

- name: Configure alias start order overrides
  become: true
  template:
    src: start-order.conf.j2
    dest: "/etc/systemd/system/kolla-{{ item.1 }}-container.service.d/start-order.conf"
    mode: "0644"
  vars:
    # Alias units use the traditional kolla-<name>-container.service naming for
    # dependencies so override the prefix/suffix accordingly.
    kolla_service_unit_prefix: "kolla-"
    kolla_service_unit_suffix: "-container"
  loop: "{{ start_order_pairs }}"
  when: kolla_container_engine == 'podman'
  notify: Reload systemd

- name: Reload systemd after applying overrides
  meta: flush_handlers

- name: Build restart list for changed overrides
  set_fact:
    start_order_override_changed_services: "{{ start_order_override_result.results | selectattr('changed') | map(attribute='item.1') | list }}"
    start_order_restart_services: "{{ start_order_override_result.results | selectattr('changed') | map(attribute='item.1') | list }}"
  when: start_order_override_result is defined

- name: Add changed containers to restart list
  set_fact:
    changed_restart_services: "{{ kolla_service_start_priority |
      select('in', (kolla_changed_containers | default([]))) | list }}"

- name: Merge restart candidates
  set_fact:
    start_order_restart_services: "{{ (start_order_restart_services |
      default([]) + changed_restart_services) | unique }}"

- name: Keep original restart candidates
  set_fact:
    start_order_restart_services_requested: "{{ start_order_restart_services | default([]) }}"

- name: Record restart candidate reason codes
  vars:
    override_services: "{{ start_order_override_changed_services | default([]) }}"
    changed_services: "{{ changed_restart_services | default([]) }}"
  set_fact:
    start_order_restart_service_reasons: >-
      {{
        start_order_restart_service_reasons | default({})
        | combine({
            item: (
              ([
                'override_changed'
                if (item in override_services)
                else none,
                'changed_container'
                if (item in changed_services)
                else none,
              ] | reject('none') | list) | unique
            )
          })
      }}
  loop: "{{ start_order_restart_services_requested | default([]) }}"

- name: Log restart candidate reasons
  debug:
    msg: >-
      Service {{ item }} queued for restart because:
      {{ start_order_restart_service_reasons.get(item, []) | join(', ') if (start_order_restart_service_reasons.get(item, []) | length > 0) else 'unspecified' }}
  loop: "{{ start_order_restart_services_requested | default([]) }}"
  when: (start_order_restart_services_requested | default([]) | length) > 0

- name: Check openvswitch runtime marker
  become: true
  stat:
    path: "{{ openvswitch_vswitchd_runtime_marker_file | default('/run/kolla/openvswitch-vswitchd-started') }}"
  register: start_order_openvswitch_runtime_marker
  changed_when: false
  when:
    - openvswitch_vswitchd_protect_runtime | default(true) | bool
    - "'openvswitch_vswitchd' in (start_order_restart_services_requested | default([]))"

- name: Gather openvswitch_vswitchd facts for runtime protection
  become: true
  kolla_container_facts:
    action: get_containers
    container_engine: "{{ kolla_container_engine }}"
    name: openvswitch_vswitchd
  register: start_order_openvswitch_facts
  changed_when: false
  failed_when: false
  when:
    - openvswitch_vswitchd_protect_runtime | default(true) | bool
    - "'openvswitch_vswitchd' in (start_order_restart_services_requested | default([]))"

- name: Evaluate openvswitch_vswitchd runtime protection state
  set_fact:
    start_order_openvswitch_runtime_marker_exists: "{{ (start_order_openvswitch_runtime_marker.stat.exists | default(false)) | bool }}"
    start_order_openvswitch_running: >-
      {{
        start_order_openvswitch_facts.containers.get('openvswitch_vswitchd', {}).get('State', {}).get('Status') == 'running'
      }}
    start_order_openvswitch_runtime_protected: >-
      {{
        (start_order_openvswitch_runtime_marker.stat.exists | default(false) | bool)
        and (openvswitch_vswitchd_protect_runtime | default(true) | bool)
        and not (openvswitch_vswitchd_break_glass | default(false) | bool)
      }}
  when:
    - "'openvswitch_vswitchd' in (start_order_restart_services_requested | default([]))"

- name: Build runtime protected service list
  set_fact:
    start_order_runtime_protected_services: >-
      {{
        (kolla_start_order_no_restart_services | default([]))
        + (['openvswitch_vswitchd'] if (start_order_openvswitch_runtime_protected | default(false) | bool) else [])
      | unique }}

- name: Filter protected services from restart list
  set_fact:
    start_order_restart_services: "{{ start_order_restart_services_requested |
      difference(start_order_runtime_protected_services | default([])) }}"

- name: Warn when runtime protection skips openvswitch_vswitchd restart
  debug:
    msg: >-
      Runtime protection marker {{ openvswitch_vswitchd_runtime_marker_file | default('/run/kolla/openvswitch-vswitchd-started') }}
      is present and openvswitch_vswitchd is running. Skipping restart/recreate in service-start-order (reason: runtime_protection_active).
      Override with openvswitch_vswitchd_break_glass=true to bypass this protection.
  when:
    - start_order_openvswitch_runtime_protected | default(false) | bool
    - start_order_openvswitch_running | default(false) | bool

- name: Warn when runtime protection enforces start-only recovery for openvswitch_vswitchd
  debug:
    msg: >-
      Runtime protection marker {{ openvswitch_vswitchd_runtime_marker_file | default('/run/kolla/openvswitch-vswitchd-started') }}
      is present but openvswitch_vswitchd is not running. Skipping restart/recreate and allowing start-only
      recovery (reason: runtime_protection_start_only). Override with
      openvswitch_vswitchd_break_glass=true to bypass this protection.
  when:
    - start_order_openvswitch_runtime_protected | default(false) | bool
    - not (start_order_openvswitch_running | default(false) | bool)

- name: Log protected services skipped for restart
  debug:
    msg: "Skipping restart for protected services per policy: {{ start_order_restart_services_requested | intersect(start_order_runtime_protected_services | default([])) }}"
  when: (start_order_restart_services_requested | intersect(start_order_runtime_protected_services | default([])) | length) > 0

- name: Show restart candidates
  debug:
    msg: "Services queued for restart: {{ start_order_restart_services }}"
  when: (start_order_restart_services | default([])) | length > 0

- name: Restart services if start order changed
  vars:
    restart_services: "{{ start_order_restart_services | default([]) }}"
  include_tasks: restart_service.yml
  loop: "{{ restart_services }}"
  loop_control:
    loop_var: svc
    label: "{{ svc }}"

- name: Start compute services in order
  include_tasks: start_service.yml
  loop: "{{ kolla_service_start_priority }}"
  loop_control:
    label: "{{ item }}"
  when: item not in (start_order_restart_services | default([]))
