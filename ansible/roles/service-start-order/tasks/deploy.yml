---
- name: Build start order pairs
  set_fact:
    start_order_pairs: "{{ kolla_service_start_priority[:-1] | zip(kolla_service_start_priority[1:]) | list }}"
  run_once: true

- name: Ensure override directories exist
  become: true
  file:
    path: "/etc/systemd/system/kolla-{{ item.1 }}-container.service.d"
    state: directory
  loop: "{{ start_order_pairs }}"
  notify: Reload systemd

- name: Configure start order overrides
  become: true
  copy:
    dest: "/etc/systemd/system/kolla-{{ item.1 }}-container.service.d/start-order.conf"
    content: |
      [Unit]
      After=kolla-{{ item.0 }}-container.service
      Requires=kolla-{{ item.0 }}-container.service
    mode: "0644"
  loop: "{{ start_order_pairs }}"
  notify: Reload systemd

- name: Start compute services in order
  become: true
  block:
    - name: Start {{ item }} service
      systemd:
        name: "kolla-{{ item }}-container.service"
        state: started
        enabled: true
    - name: Wait for neutron_ovs_cleanup to finish
      kolla_container_facts:
        action: get_containers_state
        container_engine: "{{ kolla_container_engine }}"
        name: neutron_ovs_cleanup
      register: cleanup_state
      retries: 12
      delay: 5
      until: cleanup_state.states.neutron_ovs_cleanup != 'running'
      when: item == 'neutron_ovs_cleanup'
  loop: "{{ kolla_service_start_priority }}"
  loop_control:
    label: "{{ item }}"
