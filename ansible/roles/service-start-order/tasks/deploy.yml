---
- name: Detect services with systemd units
  become: true
  stat:
    path: "{{ item.0 }}/{{ kolla_service_unit_prefix }}{{ item.1 }}{{ kolla_service_unit_suffix }}.service"
  loop: "{{ kolla_service_unit_search_paths | product(kolla_service_start_priority) | list }}"
  register: service_units

- name: Build list of services with systemd units
  set_fact:
    start_order_services: "{{ service_units.results | json_query('[?stat.exists].item[1]') | unique }}"

- name: Gather running containers
  become: true
  command: "{{ kolla_container_engine }} ps --format '{{ '{{.Names}}' }}'"
  register: start_order_containers
  changed_when: false

- name: Determine services missing systemd units
  set_fact:
    missing_unit_services: "{{ start_order_containers.stdout_lines | intersect(kolla_service_start_priority) | difference(start_order_services) }}"

- name: Generate systemd units for containers lacking them
  become: true
  block:
    - name: Generate systemd unit with create command
      command: "{{ kolla_container_engine }} generate systemd --name {{ item }} --files --new"
      args:
        chdir: /etc/systemd/system
      register: podman_generate
      failed_when: podman_generate.rc not in [0, 125]
      changed_when: podman_generate.rc == 0
      notify: Reload systemd

    - name: Generate systemd unit without create command
      command: "{{ kolla_container_engine }} generate systemd --name {{ item }} --files"
      args:
        chdir: /etc/systemd/system
      when: podman_generate.rc == 125
      register: podman_generate_fallback
      changed_when: podman_generate_fallback.rc == 0
      notify: Reload systemd

    - name: Fail if systemd unit generation failed
      when: podman_generate.rc not in [0, 125] or (podman_generate.rc == 125 and podman_generate_fallback.rc != 0)
      fail:
        msg: "podman generate systemd failed for {{ item }}"
  loop: "{{ missing_unit_services }}"
  when:
    - kolla_container_engine == 'podman'
    - missing_unit_services | length > 0

- name: Update start order services with generated units
  set_fact:
    start_order_services: "{{ start_order_services + missing_unit_services }}"
  when: missing_unit_services | length > 0

- name: Build start order pairs
  set_fact:
    start_order_pairs: "{{ start_order_services[:-1] | zip(start_order_services[1:]) | list }}"

- name: Ensure override directories exist
  become: true
  file:
    path: "/etc/systemd/system/{{ kolla_service_unit_prefix }}{{ item.1 }}{{ kolla_service_unit_suffix }}.service.d"
    state: directory
  loop: "{{ start_order_pairs }}"
  notify: Reload systemd

- name: Configure start order overrides
  become: true
  template:
    src: start-order.conf.j2
    dest: "/etc/systemd/system/{{ kolla_service_unit_prefix }}{{ item.1 }}{{ kolla_service_unit_suffix }}.service.d/start-order.conf"
    mode: "0644"
  loop: "{{ start_order_pairs }}"
  notify: Reload systemd

- name: Start compute services in order
  include_tasks: start_service.yml
  loop: "{{ kolla_service_start_priority }}"
  loop_control:
    label: "{{ item }}"
