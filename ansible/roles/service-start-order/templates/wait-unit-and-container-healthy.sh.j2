#!/bin/sh
unit="$1"
container="$2"
post_delay="${3:-0}"

until systemctl is-active --quiet "$unit"; do
    sleep 1
done

if [ "{{ kolla_container_engine }}" = "podman" ]; then
    {{ kolla_container_engine }} healthcheck run "$container" >/dev/null 2>&1
    rc=$?
    if [ "$rc" -eq 125 ]; then
        sleep {{ kolla_grace_no_healthcheck }}
    elif [ "$rc" -ne 0 ]; then
        until {{ kolla_container_engine }} healthcheck run "$container" >/dev/null 2>&1; do
            sleep 1
        done
    fi
    if [ "$post_delay" -gt 0 ]; then
        sleep "$post_delay"
    fi
elif [ "{{ kolla_container_engine }}" = "docker" ]; then
    has_hc=$({{ kolla_container_engine }} inspect --format={{"{{"}}json .Config.Healthcheck{{"}}"}} "$container")
    if [ "$has_hc" = "null" ] || [ -z "$has_hc" ]; then
        sleep {{ kolla_grace_no_healthcheck }}
    else
        until [ "$({{ kolla_container_engine }} inspect --format={{"{{"}}.State.Health.Status{{"}}"}} "$container")" = "healthy" ]; do
            sleep 1
        done
    fi
    if [ "$post_delay" -gt 0 ]; then
        sleep "$post_delay"
    fi
else
    sleep {{ kolla_grace_no_healthcheck }}
    if [ "$post_delay" -gt 0 ]; then
        sleep "$post_delay"
    fi
fi

exit 0
